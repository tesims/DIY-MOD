<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIY-MOD Quick System Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .status { padding: 8px; margin: 5px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üß™ DIY-MOD System Test</h1>
    
    <div class="test-section">
        <h3>üì° Server Connection Test</h3>
        <button onclick="testServer()">Test HTTP Server</button>
        <button onclick="testWebSocket()">Test WebSocket</button>
        <div id="serverStatus" class="status info">Click buttons to test...</div>
    </div>

    <div class="test-section">
        <h3>üîå Extension Integration Test</h3>
        <button onclick="testExtension()">Test Extension Response</button>
        <div id="extensionStatus" class="status info">Click button to test...</div>
    </div>

    <div class="test-section">
        <h3>üìù System Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testServer() {
            const statusDiv = document.getElementById('serverStatus');
            log('Testing HTTP server connection...');
            
            try {
                const response = await fetch('http://localhost:5001/ping');
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ HTTP Server: Connected and responding';
                    log('‚úÖ HTTP server test passed');
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå HTTP Server: Failed to connect';
                log(`‚ùå HTTP server test failed: ${error.message}`);
            }
        }

        function testWebSocket() {
            const statusDiv = document.getElementById('serverStatus');
            log('Testing WebSocket connection...');
            
            try {
                const ws = new WebSocket('ws://localhost:5001/ws/test_user');
                
                ws.onopen = function() {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ WebSocket: Connected successfully';
                    log('‚úÖ WebSocket connection opened');
                    
                    // Send test message
                    ws.send(JSON.stringify({
                        type: 'test',
                        data: 'Hello from quick test!'
                    }));
                };
                
                ws.onmessage = function(event) {
                    log(`üì• WebSocket message received: ${event.data}`);
                };
                
                ws.onerror = function(error) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå WebSocket: Connection failed';
                    log(`‚ùå WebSocket error: ${error}`);
                };
                
                ws.onclose = function(event) {
                    log(`üîå WebSocket closed (code: ${event.code})`);
                };
                
                // Close connection after 3 seconds
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                    }
                }, 3000);
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå WebSocket: Failed to initialize';
                log(`‚ùå WebSocket initialization failed: ${error.message}`);
            }
        }

        function testExtension() {
            const statusDiv = document.getElementById('extensionStatus');
            log('Testing extension integration...');
            
            // Create a test SaveBatch event
            const testEvent = new CustomEvent('SaveBatch', {
                detail: {
                    id: `test_${Date.now()}`,
                    type: 'reddit',
                    url: 'https://www.reddit.com/r/test',
                    response: '<div>Test content</div>'
                }
            });
            
            // Listen for the response
            const responseHandler = function(event) {
                if (event.detail.id.startsWith('test_')) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Extension: Responding to events';
                    log('‚úÖ Extension responded to test event');
                    window.removeEventListener('CustomFeedReady', responseHandler);
                }
            };
            
            window.addEventListener('CustomFeedReady', responseHandler);
            
            // Dispatch the test event
            window.dispatchEvent(testEvent);
            log('üì§ Test event dispatched to extension');
            
            // Set timeout to show failure if no response
            setTimeout(() => {
                if (statusDiv.textContent.includes('Click button')) {
                    statusDiv.className = 'status warning';
                    statusDiv.textContent = '‚ö†Ô∏è Extension: No response (may not be loaded)';
                    log('‚ö†Ô∏è No response from extension - extension may not be installed/loaded');
                    window.removeEventListener('CustomFeedReady', responseHandler);
                }
            }, 2000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Auto-run tests on page load
        window.onload = function() {
            log('üöÄ DIY-MOD Quick Test initialized');
            log('Run tests using the buttons above');
            
            // Check if this is running on a supported page
            if (window.location.href.includes('reddit.com') || window.location.href.includes('twitter.com') || window.location.href.includes('x.com')) {
                log('‚úÖ Running on supported platform');
            } else {
                log('‚ÑπÔ∏è Running on test page (not Reddit/Twitter)');
            }
        };
    </script>
</body>
</html> 